<!doctype html>
<html lang="en">
	<!--
	MIT License

	Copyright (c) 2020 razuhl

	Permission is hereby granted, free of charge, to any person obtaining a copy
	of this software and associated documentation files (the "Software"), to deal
	in the Software without restriction, including without limitation the rights
	to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
	copies of the Software, and to permit persons to whom the Software is
	furnished to do so, subject to the following conditions:

	The above copyright notice and this permission notice shall be included in all
	copies or substantial portions of the Software.

	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
	SOFTWARE.
	-->
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="https://razuhl.github.io/vmms/dependencies/bootstrap-4.3.1/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		<script type="text/javascript">
			function escapeHTML(str) {
				return str.replace(/[&<>]/g,function(m) {
					switch ( m ) {
						case '&': return '&amp;';
						case '<': return '&lt;';
						case '>': return '&gt;';
					}
					return 'error';
				});
			}
			
			function clearStatus() {
				$('.modal-body .alert').each(function(indx,e) { $(e).alert('close'); });
				$('div.modal-body .is-invalid').removeClass('is-invalid');
				$('div.modal-body .is-valid').removeClass('is-valid');
				$('div.modal-body .invalid-feedback').remove();
				$('div.modal-body .valid-feedback').remove();
			}
			
			function defaults() {
				$('div.modal-body .dataHolder').each(function(indx,e) {
					e = $(e);
					if ( e.data('default') !== undefined ) {
						propertyHandlers[e.data('type')].setPropertyValue(e,e.data('default'));
					}
				});
				clearStatus();
			}
			
			function buildProperty(container,name,cfg) {
				propertyHandlers[cfg.type].buildProperty(container,name,cfg);
				var e = $('#' + name);
				e.data('type',cfg.type)
				if ( typeof cfg.default !== 'undefined' )
					e.data('default',cfg.default);
			}
			
			function setPropertyValue(name, value) {
				var e = $('#VMPropsModal #' + name);
				propertyHandlers[e.data('type')].setPropertyValue(e,value);
			}
			
			window.onload = function() {
				var targetWindow = null;
				if ( window.opener !== null ) targetWindow = window.opener;
				else if ( window.parent !== null ) targetWindow = window.parent;
				
				if ( targetWindow !== null ) {
					//hidden vars
					var pairedWindow, pairedDomain;
					var rsaKey, callerPublicKey, callerAesKey;
					//function pointer to switch between handshake and normal communication
					var listenerHandshake = null;
					var listener = null;
					var listenerImpl = null;
					
					var sendMessage = function(data) {
						if ( pairedWindow !== null && pairedDomain !== null && data !== null && typeof data === 'object' ) {
							var iv = window.crypto.getRandomValues(new Uint8Array(12));
							window.crypto.subtle.encrypt({ name: "RSA-OAEP" }, callerPublicKey, iv).then(ivEncrypted => {
								window.crypto.subtle.encrypt({name: "AES-GCM",iv: iv},callerAesKey,new TextEncoder().encode(JSON.stringify(data))).then(encrypted => {
									if ( pairedWindow !== null && pairedDomain !== null )
										pairedWindow.postMessage({data: encrypted, token: ivEncrypted},pairedDomain);
								}).catch(err => {
									console.log(err);
								});
							}).catch(err => {
								console.log(err);
							});
						}
					};
					
					$('#btn_save').on('click',function () {
						var values = {};
						
						$('div.modal-body .dataHolder').each(function(indx,e) {
							e = $(e);
							values[e.attr('id')] = propertyHandlers[e.data('type')].getPropertyValue(e);
						});
						
						sendMessage({lifecycle: 'Save', values: values});
					});
					
					$('#btn_close, button.close').on('click',function () {
						sendMessage({lifecycle: 'Close'});
					});
					
					var reportSuccess = function(originalLifecycle) {
						sendMessage({lifecycle: originalLifecycle+'Success'});
					};
					
					var reportFailure = function(originalLifecycle) {
						sendMessage({lifecycle: originalLifecycle+'Failure'});
					};
					
					listenerHandshake = function(msg) {
						if ( typeof msg.data === 'object' && typeof msg.data.publicKey !== 'undefined' && typeof msg.data.passphrase !== 'undefined' ) {
							try {
								crypto.subtle.unwrapKey('jwk',msg.data.passphrase,rsaKey.privateKey,rsaKey.privateKey.algorithm.name,'AES-GCM',true,["encrypt", "decrypt"])
									.then(aesKeyUnwrapped => {
										try {
											pairedWindow = msg.source;
											pairedDomain = msg.origin;
											callerAesKey = aesKeyUnwrapped;
											callerPublicKey = msg.data.publicKey;
											window.crypto.subtle.encrypt({ name: "RSA-OAEP" }, callerPublicKey, new TextEncoder().encode('GetConfiguration')).then(lifecycleEncrypted => {
												listenerImpl = listener;
												pairedWindow.postMessage({lifecycle: lifecycleEncrypted},pairedDomain);
											});
										} catch (err) {
											console.log('failed to encrypt aes key: '+err);
											pairedWindow = pairedDomain = callerPublicKey = callerAesKey = null;
										}
									});
							} catch (err) {
								console.log('failed to decrypt passphrase: '+err);
								pairedWindow = pairedDomain = callerPublicKey = callerAesKey = null;
							}
						}
					};
					listener = function(msg) {
						if ( msg.source === pairedWindow && msg.origin === pairedDomain && typeof msg.data !== 'undefined' ) {
							clearStatus();
							window.crypto.subtle.decrypt({ name: rsaKey.privateKey.algorithm.name }, rsaKey.privateKey, msg.data.token).then(iv => {
								window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, callerAesKey, msg.data.data).then(data => {
									data = new TextDecoder().decode(data);
									if ( typeof data !== 'string' ) {
										console.log('invalid data detected!');
										return;
									}
									data = JSON.parse(data);
									if ( typeof data !== 'object' ) {
										console.log('invalid data detected!');
										return;
									}
									if ( data.lifecycle === 'Configure' ) {
										try {
											var dlg = document.querySelector('#VMPropsModal');
											dlg.querySelector('#modalLabel').innerHtml = data.title;
											
											var dlgClass = $('div.modal-dialog');
											dlgClass.removeClass(['modal-sm','modal-lg','modal-xl']);
											if ( data.dlgSize !== undefined && data.dlgSize !== null ) {
												if ( data.dlgSize === 'xl' ) {
													dlgClass.addClass('modal-xl');
												} else if ( data.dlgSize === 'l' ) {
													dlgClass.addClass('modal-lg');
												} else if ( data.dlgSize === 's' ) {
													dlgClass.addClass('modal-sm');
												} else dlgClass.addClass(data.dlgSize);
											}
											
											var dlgBody = dlg.querySelector('div.modal-body');
											$(dlgBody).empty();
											
											var hasDefaults = false;
											for (var name in data.props) {
												buildProperty(dlgBody,name,data.props[name]);
												hasDefaults = hasDefaults || typeof data.props[name].default !== 'undefined';
											}
											for (var name in data.values) {
												setPropertyValue(name,data.values[name]);
											}
											
											if ( !hasDefaults ) {
												dlg.querySelector('#btn_defaults').style.display = 'none';
											} else {
												dlg.querySelector('#btn_defaults').style.display = null;
											}
											
											$(dlg).modal({backdrop: 'static'});
											reportSuccess(data.lifecycle);
										} catch (err) {
											console.log(err);
											reportFailure(data.lifecycle);
										}
									} else if ( data.lifecycle === 'UpdateValues' ) {
										for (var name in data.values) {
											setPropertyValue(name,data.values[name]);
										}
									} else if ( data.lifecycle === 'UpdateValue' ) {
										setPropertyValue(data.propertyName,data.propertyValue);
									} else if ( data.lifecycle === 'SaveSuccess' ) {
										$('.modal-body').append('<div class="alert alert-success alert-dismissible">' +
											'<button type="button" class="close" data-dismiss="alert">&times;</button>Saved</div>');
									} else if ( data.lifecycle === 'SaveFailure' ) {
										$('.modal-body').append('<div class="alert alert-danger alert-dismissible">' +
											'<button type="button" class="close" data-dismiss="alert">&times;</button>Failed to Save</div>');
									}
									
									if ( data.lifecycle === 'SaveSuccess' || data.lifecycle === 'SaveFailure' ) {
										if ( data.validations ) {
											for ( var name in data.validations ) {
												var e = $('#' + name);
												propertyHandlers[e.data('type')].displayValidation(e,data.validations[name]);
											}
										}
										$('div.modal-body .dataHolder').not('.is-invalid').addClass('is-valid');
									}
								});
							});
						}
					};
					listenerImpl = listenerHandshake;
					window.addEventListener('message', function(e){return listenerImpl(e);});
					try {
						window.crypto.subtle.generateKey(
							{
								name: "RSA-OAEP",
								modulusLength: 2048,
								publicExponent: new Uint8Array([1, 0, 1]),
								hash: "SHA-256",
							},
							true,
							["encrypt", "decrypt", "wrapKey", "unwrapKey"]
						).then((rsaKeyLocal) => {
							rsaKey = rsaKeyLocal;
							targetWindow.postMessage({publicKey: rsaKey.publicKey},'*');
						});
					} catch (err) {
						console.log('failed to generate key when creating dialog: '+err);
						rsaKey = null;
					}
				}
			}
			
			function shiftElementUp(e) {
				e.prev().insertAfter(e);
			}
			
			function shiftElementDown(e) {
				e.next().insertBefore(e);
			}
			
			propertyHandlers = {
				text: {
					setPropertyValue: function(e, value) {
						e.val(value);
					},
					buildProperty: function(container,name,cfg) {
						$(container).append(
							'<div class="form-group">' +
								'<label for="' + name + '">' + escapeHTML(cfg.label) + '</label>' +
								'<input type="text" class="form-control dataHolder" id="' + name + '">' +
								( typeof cfg.tooltip !== 'undefined' ? '<small class="form-text text-muted">' + escapeHTML(cfg.tooltip) + '</small>' : '') +
							'</div>');
					},
					getPropertyValue: function(e) {
						return e.val();
					},
					displayValidation: function(e,validation) {
						for ( var indx in validation.messages ) {
							e.after('<div class="'+(validation.isValid?'valid-feedback':'invalid-feedback')+'">' + escapeHTML(validation.messages[indx]) + '</div>');
						}
						if ( !validation.isValid )
							e.addClass('is-invalid');
					}
				},
				textarea: {
					setPropertyValue: function(e, value) {
						e.val(value);
					},
					buildProperty: function(container,name,cfg) {
						$(container).append(
							'<div class="form-group">' +
								'<label for="' + name + '">' + escapeHTML(cfg.label) + '</label>' +
								'<textarea class="form-control dataHolder" id="' + name + '"></textarea>' +
								( typeof cfg.tooltip !== 'undefined' ? '<small class="form-text text-muted">' + escapeHTML(cfg.tooltip) + '</small>' : '') +
							'</div>');
					},
					getPropertyValue: function(e) {
						return e.val();
					},
					displayValidation: function(e,validation) {
						for ( var indx in validation.messages ) {
							e.after('<div class="'+(validation.isValid?'valid-feedback':'invalid-feedback')+'">' + escapeHTML(validation.messages[indx]) + '</div>');
						}
						if ( !validation.isValid )
							e.addClass('is-invalid');
					}
				},
				select: {
					setPropertyValue: function(e, value) {
						e.val(value);
					},
					buildProperty: function(container,name,cfg) {
						$(container).append(
							'<div class="form-group">' +
								'<label for="' + name + '">' + escapeHTML(cfg.label) + '</label>' +
								'<select class="form-control dataHolder" id="' + name + '"></select>' +
								( typeof cfg.tooltip !== 'undefined' ? '<small class="form-text text-muted">' + escapeHTML(cfg.tooltip) + '</small>' : '') +
							'</div>');
						var select = $(container).find('select');
						for (var indx in cfg.options) {
							var option = cfg.options[indx];
							$('<option></option>').text(option.label).val(option.value).appendTo(select);
						}
					},
					getPropertyValue: function(e) {
						return e.find('option:selected').val();
					},
					displayValidation: function(e,validation) {
						for ( var indx in validation.messages ) {
							e.after('<div class="'+(validation.isValid?'valid-feedback':'invalid-feedback')+'">' + escapeHTML(validation.messages[indx]) + '</div>');
						}
						if ( !validation.isValid )
							e.addClass('is-invalid');
					}
				},
				checkbox: {
					setPropertyValue: function(e, value) {
						e.prop('checked', value == true);
					},
					buildProperty: function(container,name,cfg) {
						$(container).append(
							'<div class="form-check">' +
								'<input type="checkbox" class="form-check-input dataHolder" id="' + name + '">' +
								'<label for="' + name + '" class="form-check-label">' + escapeHTML(cfg.label) + '</label>' +
							'</div>').append(( typeof cfg.tooltip !== 'undefined' ? '<small class="form-text text-muted">' + escapeHTML(cfg.tooltip) + '</small>' : ''));
					},
					getPropertyValue: function(e) {
						return e.is(':checked');
					},
					displayValidation: function(e,validation) {
						for ( var indx in validation.messages ) {
							e.parent().after('<div class="'+(validation.isValid?'valid-feedback':'invalid-feedback')+'" style="display: block">' + escapeHTML(validation.messages[indx]) + '</div>');
						}
						if ( !validation.isValid )
							e.addClass('is-invalid');
					}
				},
				list_text: {
					setPropertyValue: function(e, items) {
						e.find('div.input-group').remove();
						for (var indx in items) {
							var item = items[indx];
							propertyHandlers.list_text.addNewItem(e,item);
						}
					},
					addNewItem: function(e,value) {
						$('<div class="input-group">' +
							'<input type="text" class="form-control">' +
							'<div class="input-group-append">' +
								'<button type="button" onclick="shiftElementDown($(this).parent().parent());" class="btn btn-info">V</button>' +
								'<button type="button" onclick="shiftElementUp($(this).parent().parent());" class="btn btn-info">A</button>' +
								'<button type="button" onclick="$(this).parent().parent().remove();" class="btn btn-danger">-</button>' +
							'</div>' +
						'</div>').appendTo(e).find('input').val(value);
					},
					buildProperty: function(container,name,cfg) {
						$(container).append(
							'<div class="form-group">' +
								'<label for="' + name + '">' + escapeHTML(cfg.label) + '</label>' +
								'<div class="dataHolder" id="' + name + '"></div>' +
								'<div class="input-group" style="margin-top: 0.25rem"><button type="button" class="form-control btn btn-info" onclick="propertyHandlers.list_text.addNewItem($(\'#'+name+'\'),\'\');">+</button></div>' +
								( typeof cfg.tooltip !== 'undefined' ? '<small class="form-text text-muted">' + escapeHTML(cfg.tooltip) + '</small>' : '') +
							'</div>');
					},
					getPropertyValue: function(e) {
						var list = [];
						e.find('input.form-control').each(function(indx,e) {list.push($(e).val());});
						return list;
					},
					displayValidation: function(e,validation) {
						if ( !validation.isValid ) {
							e.find('input.form-control').addClass('is-invalid');
							e.parent().find('div.input-group>button').addClass('is-invalid');
						}
						var addButton = e.parent().children('div.input-group');
						for ( var indx in validation.messages ) {
							addButton.after('<div class="'+(validation.isValid?'valid-feedback':'invalid-feedback')+'" style="display: block">' + escapeHTML(validation.messages[indx]) + '</div>');
						}
					}
				}
			};
		</script>
	</head>
	<body>
		<div class="modal fade" id="VMPropsModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="modalLabel">VM Props</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
					</div>
					<div class="modal-footer">
						<button id="btn_save" type="button" class="btn btn-primary">Save changes</button>
						<button id="btn_defaults" type="button" class="btn btn-secondary" onclick="defaults()">Defaults</button>
						<button id="btn_close" type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
		
		<script src="https://razuhl.github.io/vmms/dependencies/jquery-3.3.1/jquery.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
		<script src="https://razuhl.github.io/vmms/dependencies/popper-core-1.14.7/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
		<script src="https://razuhl.github.io/vmms/dependencies/bootstrap-4.3.1/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
	</body>
</html>