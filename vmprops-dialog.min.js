/*
 MIT License
 
 Copyright (c) 2020 razuhl
 
 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:
 
 The above copyright notice and this permission notice shall be included in all
 copies or substantial portions of the Software.
 
 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.
 */
class Communicator{pairedWindow=null;pairedDomain=null;rsaKey=null;callerPublicKey=null;callerAesKey=null;handler=null;constructor(e,a){this.handler=e,window.addEventListener("message",this.listenerHandshake.bind(this));try{window.crypto.subtle.generateKey({name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},!0,["encrypt","decrypt","wrapKey","unwrapKey"]).then(e=>{this.rsaKey=e,a.postMessage({publicKey:this.rsaKey.publicKey},"*")}).catch(e=>{console.log(e)})}catch(e){console.log("failed to generate key when creating dialog: "+e),this.rsaKey=null}}sendMessage(e){if(null!==this.pairedWindow&&null!==this.pairedDomain&&null!==e&&"object"==typeof e){var a=window.crypto.getRandomValues(new Uint8Array(12));window.crypto.subtle.encrypt({name:"RSA-OAEP"},this.callerPublicKey,a).then(t=>{window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},this.callerAesKey,(new TextEncoder).encode(JSON.stringify(e))).then(e=>{null!==this.pairedWindow&&null!==this.pairedDomain&&this.pairedWindow.postMessage({data:e,token:t},this.pairedDomain)}).catch(e=>{console.log(e)})}).catch(e=>{console.log(e)})}}reportSuccess(e){this.sendMessage({lifecycle:e+"Success"})}reportFailure(e){this.sendMessage({lifecycle:e+"Failure"})}listenerHandshake(e){if("object"==typeof e.data&&void 0!==e.data.publicKey&&void 0!==e.data.passphrase)try{crypto.subtle.unwrapKey("jwk",e.data.passphrase,this.rsaKey.privateKey,this.rsaKey.privateKey.algorithm.name,"AES-GCM",!0,["encrypt","decrypt"]).then(a=>{try{this.pairedWindow=e.source,this.pairedDomain=e.origin,this.callerAesKey=a,this.callerPublicKey=e.data.publicKey,window.crypto.subtle.encrypt({name:"RSA-OAEP"},this.callerPublicKey,(new TextEncoder).encode("GetConfiguration")).then(e=>{window.removeEventListener("message",this.listenerHandshake),window.addEventListener("message",this.listener.bind(this)),this.pairedWindow.postMessage({lifecycle:e},this.pairedDomain)})}catch(e){console.log("failed to encrypt aes key: "+e),this.pairedWindow=this.pairedDomain=this.callerPublicKey=this.callerAesKey=null}})}catch(e){console.log("failed to decrypt passphrase: "+e),this.pairedWindow=this.pairedDomain=this.callerPublicKey=this.callerAesKey=null}}listener(e){e.source===this.pairedWindow&&e.origin===this.pairedDomain&&void 0!==e.data&&(this.handler.clearStatus(),window.crypto.subtle.decrypt({name:this.rsaKey.privateKey.algorithm.name},this.rsaKey.privateKey,e.data.token).then(a=>{window.crypto.subtle.decrypt({name:"AES-GCM",iv:a},this.callerAesKey,e.data.data).then(e=>{if("string"==typeof(e=(new TextDecoder).decode(e)))if("object"==typeof(e=JSON.parse(e))){if("Configure"===e.lifecycle)try{var a=document.querySelector("#VMPropsModal");$("#modalLabel").text(e.title),$("head>title").text(e.title),this.handler.props=e.props,this.handler.currentValue=e.values,this.handler.rootValue=e.values,this.handler.rootProps=e.props;var t=$("div.modal-dialog");t.removeClass(["modal-sm","modal-lg","modal-xl"]),void 0!==e.dlgSize&&null!==e.dlgSize&&("xl"===e.dlgSize?t.addClass("modal-xl"):"l"===e.dlgSize?t.addClass("modal-lg"):"s"===e.dlgSize?t.addClass("modal-sm"):t.addClass(e.dlgSize)),this.handler.buildBody(),$(a).modal({backdrop:"static"}),this.reportSuccess(e.lifecycle)}catch(a){console.log(a),this.reportFailure(e.lifecycle)}else if("UpdateValues"===e.lifecycle)for(var l in e.values)this.handler.setPropertyValue(l,e.values[l]);else"UpdateValue"===e.lifecycle?this.handler.setPropertyValue(e.propertyName,e.propertyValue):"SaveSuccess"===e.lifecycle?$(".modal-body").append('<div class="alert alert-success alert-dismissible"><button type="button" class="close" data-dismiss="alert">&times;</button>Saved</div>'):"SaveFailure"===e.lifecycle&&$(".modal-body").append('<div class="alert alert-danger alert-dismissible"><button type="button" class="close" data-dismiss="alert">&times;</button>Failed to Save</div>');if("SaveSuccess"===e.lifecycle||"SaveFailure"===e.lifecycle){var r=!1;"SaveSuccess"===e.lifecycle&&(this.forAny(e.validations,e=>void 0!==e.__messages&&e.__messages.length>0)||($("#btn_close").click(),r=!0)),r||this.processValidationResult(e.validations)}}else console.log("invalid data detected!");else console.log("invalid data detected!")})}))}forAny(e,a){if(a(e))return!0;if("object"==typeof e||Array.isArray(e))for(const t in e){const l=e[t];if(this.forAny(l,a))return!0}return!1}buildHTMLMessagePreamble(e,a){for(var t=null,l=Math.max(0,a);l<e.length;l++)void 0!==e[l].index?null===t?t=a>=0?'<span class="badge badge-pill badge-dark">'+e[l].index+"</span>":'<span class="badge badge-pill badge-info"><span class="badge badge-pill badge-dark">'+e[l].index+"</span>"+e[l].label+"</span>":t+='<span class="badge badge-pill badge-info"><span class="badge badge-pill badge-dark">'+e[l].index+"</span>"+e[l].label+"</span>":null===t?t=a>=0?"":'<span class="badge badge-pill badge-info">'+e[l].label+"</span>":t+='<span class="badge badge-pill badge-info">'+e[l].label+"</span>";return null!==t?t:""}processValidationResult(e){if(e){var a=function*(e){for(const a in e)a.startsWith("__")||(yield{propertyName:a,propertyValue:e[a]})},t=[],l=[],r=[],i=[],s=[],o=this.handler.rootProps,n=this.handler.rootValue,d=a(e),p=1e6,c=this.handler.props===this.handler.rootProps?0:-1,u=!0,v=$("#validationMessagesGlobal"),f=$("#validationMessagesCurrent");if(e.__messages)if(this.handler.props===this.handler.rootProps)for(const a of e.__messages)f.append('<div class="'+(e.__isValid?"valid-feedback":"invalid-feedback")+'">'+this.handler.escapeHTML(a)+"</div>");else for(const a of e.__messages)v.append('<div class="'+(e.__isValid?"valid-feedback":"invalid-feedback")+'">'+this.handler.escapeHTML(a)+"</div>");for(;p>0;){p--;var m=d.next();if(m.done){if(void 0===(d=s.pop()))break;var b=r.pop();null!==b&&c===t.length-1&&(this.handler.propertyHandlers[o.type].displayValidation($("#"+t[t.length-1].name),{isValid:u,messages:l}),l.splice(0,l.length),u=!0),n===this.handler.currentValue&&(c=-1),n=i.pop(),null!==b?(o=b,t.pop()):delete t[t.length-1].index}else{if(s.push(d),void 0===o.props&&void 0!==o[m.value.propertyName]||void 0!==o.props&&void 0!==o.props[m.value.propertyName]?(r.push(o),o=void 0!==o.props?o.props[m.value.propertyName]:o[m.value.propertyName],void 0!==n&&(i.push(n),n=n[m.value.propertyName]),t.push({label:o.label,name:m.value.propertyName}),n===this.handler.currentValue&&(c=t.length,u=!0)):(t[t.length-1].index=m.value.propertyName,i.push(n),(n=n[m.value.propertyName])===this.handler.currentValue&&(c=t.length,u=!0),r.push(null)),void 0!==m.value.propertyValue.__isValid){var y=m.value.propertyValue.__messages;if(void 0!==y)if(-1===c){if(y.length>0){var h=this.buildHTMLMessagePreamble(t,c);for(const e of y)v.append('<div class="'+(m.value.propertyValue.__isValid?"valid-feedback":"invalid-feedback")+'">'+h+this.handler.escapeHTML(e)+"</div>")}}else if(n===this.handler.currentValue){if(y.length>0){h=this.buildHTMLMessagePreamble(t,c);for(const e of y)f.append('<div class="'+(m.value.propertyValue.__isValid?"valid-feedback":"invalid-feedback")+'">'+h+this.handler.escapeHTML(e)+"</div>")}}else{if(y.length>0){h=this.buildHTMLMessagePreamble(t,c);for(const e of y)l.push({message:h+this.handler.escapeHTML(e),isValid:m.value.propertyValue.__isValid,listEntry:t[Math.max(0,c)].index})}else l.push({message:"No Message",isValid:m.value.propertyValue.__isValid,listEntry:t[Math.max(0,c)].index});u=u&&m.value.propertyValue.__isValid}}d=a(m.value.propertyValue)}}}$("div.modal-body .dataHolder").not(".is-invalid").addClass("is-valid")}}class Handler{props=null;currentValue=null;rootValue=null;rootProps=null;constructor(e){var a=new Communicator(this,e);$("#btn_save").on("click",()=>{this.copyValuesIntoModel(),a.sendMessage({lifecycle:"Save",values:this.rootValue})}),$("#btn_close, button.close").on("click",()=>{a.sendMessage({lifecycle:"Close"})}),$("#btn_defaults").on("click",()=>this.defaults()),window.vmPropsHandler=this}escapeHTML(e){return e.replace(/[&<>]/g,(function(e){switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;"}return"error"}))}clearStatus(){$(".modal-body .alert").each((function(e,a){$(a).alert("close")})),$("div.modal-body .is-invalid").removeClass("is-invalid"),$("div.modal-body .is-valid").removeClass("is-valid"),$("div.modal-body .invalid-feedback").remove(),$("div.modal-body .valid-feedback").remove()}defaults(){var e=this;$("div.modal-body .dataHolder").each((function(a,t){void 0!==(t=$(t)).data("default")&&e.propertyHandlers[t.data("type")].setPropertyValue(t,JSON.parse(JSON.stringify(t.data("default"))))})),this.clearStatus()}addImpliedDefaultValues(e,a){if(null!=e&&void 0!==a.props)for(const t in a.props)if(void 0!==a.props[t].default)if(Array.isArray(e))for(const l of e)null!==l&&(void 0===l[t]&&(l[t]=a.props[t].default),this.addImpliedDefaultValues(l[t],a.props[t]));else void 0===e[t]&&(e[t]=a.props[t].default),this.addImpliedDefaultValues(e[t],a.props[t])}buildProperty(e,a,t){this.propertyHandlers[t.type].buildProperty(e,a,t);var l=$("#"+a);l.data("type",t.type),void 0!==t.default&&(this.addImpliedDefaultValues(t.default,t),l.data("default",t.default))}setPropertyValue(e,a){var t=$("#VMPropsModal #"+e);this.propertyHandlers[t.data("type")].setPropertyValue(t,a)}shiftElementUp(e){var a=e.prev();if(a.length>0){a.insertAfter(e);var t=a.find("button.btn-dark");t.text(parseInt(t.text())+1),(t=e.find("button.btn-dark")).text(parseInt(t.text())-1)}}shiftElementDown(e){var a=e.next();if(a.length>0){a.insertBefore(e);var t=a.find("button.btn-dark");t.text(parseInt(t.text())-1),(t=e.find("button.btn-dark")).text(parseInt(t.text())+1)}}gotoCrumb(e,a,t,l){this.prePageChange(),$("#modalLabel").text(l),this.currentValue=a,this.props=t,e.parent().nextAll().remove(),e.parent().remove(),0===$("#modalBreadcrumb a").length&&$("#modalBreadcrumb").parent().parent().css("display","none"),this.buildBody()}copyValuesIntoModel(){var e=this;$("div.modal-body .dataHolder").each((function(a,t){t=$(t),e.currentValue[t.attr("id")]=e.propertyHandlers[t.data("type")].getPropertyValue(t)}))}prePageChange(){this.copyValuesIntoModel()}buildBody(){try{var e=document.querySelector("#VMPropsModal"),a=e.querySelector("div.modal-body");$(a).empty();var t=!1;for(var l in this.props)this.buildProperty(a,l,this.props[l]),t=t||void 0!==this.props[l].default;for(var l in this.currentValue)void 0!==this.props[l]&&this.setPropertyValue(l,this.currentValue[l]);$(a).append('<div id="validationMessagesCurrent" class="form-group"></div>').append('<div id="validationMessagesGlobal" class="form-group"></div>'),e.querySelector("#btn_defaults").style.display=t?null:"none"}catch(e){console.log(e)}}gotoProperty(e,a){this.prePageChange();const t=this.currentValue,l=$("#modalLabel").text(),r=this.props;if($("#modalBreadcrumb").append('<li class="breadcrumb-item"><a href="#">'+l+"</a></li>"),$("#modalBreadcrumb a").last().on("click.vmprops",(function(){window.vmPropsHandler.gotoCrumb($(this),t,r,l)})),$("#modalBreadcrumb").parent().parent().css("display",""),null!=a){var i,s=$(a).closest(".input-group")[0];for(i=0;s=s.previousSibling;i++);$("#modalLabel").text(this.props[e].label).append('<span class="badge badge-pill badge-dark">'+i+"</span>")}else $("#modalLabel").text(this.props[e].label);s=$("#"+e);this.currentValue=null==a?this.propertyHandlers[s.data("type")].getPropertyValue(s):$(a).data("value"),this.props=this.props[e].props,this.buildBody()}listButtonsPrepend(e){return'<div class="input-group-prepend mr-1"><button type="button" class="btn btn-dark">'+e[0].childElementCount+"</button></div>"}listButtonsAppend(e){return'<div class="input-group-append ml-1"><button type="button" onclick="window.vmPropsHandler.shiftElementDown($(this).parent().parent());" class="btn btn-info">V</button><button type="button" onclick="window.vmPropsHandler.shiftElementUp($(this).parent().parent());" class="btn btn-info">A</button>'+(e.data("removable")?'<button type="button" onclick="$(this).parent().parent().remove();" class="btn btn-danger remover">-</button>':"")+"</div>"}parseLabel(e,a){return e.replace(/\${([^}]*)}/g,(e,t)=>{var l=t.split("."),r=a;for(var i of l)r=r[i];return r})}propertyHandlers={text:{setPropertyValue:function(e,a){e.val(a)},buildProperty:function(e,a,t){$(e).append('<div class="form-group"><label for="'+a+'">'+window.vmPropsHandler.escapeHTML(t.label)+'</label><input type="text" class="form-control dataHolder" id="'+a+'">'+(void 0!==t.tooltip?'<small class="form-text text-muted">'+window.vmPropsHandler.escapeHTML(t.tooltip)+"</small>":"")+"</div>")},getPropertyValue:function(e){return e.val()},displayValidation:function(e,a){var t=e;for(const e of a.messages)t.after('<div class="'+(e.isValid?"valid-feedback":"invalid-feedback")+'">'+e.message+"</div>"),t=t.next();a.isValid||e.addClass("is-invalid")}},number:{setPropertyValue:function(e,a){e.val(window.vmPropsHandler.propertyHandlers.number.format(a))},buildProperty:function(e,a,t){$(e).append('<div class="form-group"><label for="'+a+'">'+window.vmPropsHandler.escapeHTML(t.label)+'</label><input type="number" class="form-control dataHolder" id="'+a+'">'+(void 0!==t.tooltip?'<small class="form-text text-muted">'+window.vmPropsHandler.escapeHTML(t.tooltip)+"</small>":"")+"</div>")},getPropertyValue:function(e){return window.vmPropsHandler.propertyHandlers.number.parse(e.val())},displayValidation:function(e,a){var t=e;for(const e of a.messages)t.after('<div class="'+(e.isValid?"valid-feedback":"invalid-feedback")+'">'+e.message+"</div>"),t=t.next();a.isValid||e.addClass("is-invalid")},format:function(e){switch(typeof e){case"number":return JSON.stringify(e);case"string":return e}return""},parse:function(e){switch(typeof e){case"number":return e;case"string":try{var a=JSON.parse(e);return"number"==typeof a?a:null}catch(e){return null}}return null}},textarea:{setPropertyValue:function(e,a){e.val(a)},buildProperty:function(e,a,t){$(e).append('<div class="form-group"><label for="'+a+'">'+window.vmPropsHandler.escapeHTML(t.label)+'</label><textarea class="form-control dataHolder" id="'+a+'"></textarea>'+(void 0!==t.tooltip?'<small class="form-text text-muted">'+window.vmPropsHandler.escapeHTML(t.tooltip)+"</small>":"")+"</div>")},getPropertyValue:function(e){return e.val()},displayValidation:function(e,a){var t=e;for(const e of a.messages)t.after('<div class="'+(e.isValid?"valid-feedback":"invalid-feedback")+'">'+e.message+"</div>"),t=t.next();a.isValid||e.addClass("is-invalid")}},select:{setPropertyValue:function(e,a){e.val(a)},buildProperty:function(e,a,t){$(e).append('<div class="form-group"><label for="'+a+'">'+window.vmPropsHandler.escapeHTML(t.label)+'</label><select class="form-control dataHolder" id="'+a+'"></select>'+(void 0!==t.tooltip?'<small class="form-text text-muted">'+window.vmPropsHandler.escapeHTML(t.tooltip)+"</small>":"")+"</div>");var l=$(e).find("select");for(var r in t.options){var i=t.options[r];$("<option></option>").text(i.label).val(i.value).data("value",i.value).appendTo(l)}},getPropertyValue:function(e){return e.find("option:selected").data("value")},displayValidation:function(e,a){var t=e;for(const e of a.messages)t.after('<div class="'+(e.isValid?"valid-feedback":"invalid-feedback")+'">'+e.message+"</div>"),t=t.next();a.isValid||e.addClass("is-invalid")}},checkbox:{setPropertyValue:function(e,a){e.prop("checked",!0===a)},buildProperty:function(e,a,t){$(e).append('<div class="form-check"><input type="checkbox" class="form-check-input dataHolder" id="'+a+'"><label for="'+a+'" class="form-check-label">'+window.vmPropsHandler.escapeHTML(t.label)+"</label>"+(void 0!==t.tooltip?'<small class="form-text text-muted">'+window.vmPropsHandler.escapeHTML(t.tooltip)+"</small>":"")+"</div>")},getPropertyValue:function(e){return e.is(":checked")},displayValidation:function(e,a){var t=e.next();for(const e of a.messages)t.after('<div class="'+(e.isValid?"valid-feedback":"invalid-feedback")+'">'+e.message+"</div>"),t=t.next();a.isValid||e.addClass("is-invalid")}},list_text:{setPropertyValue:function(e,a){for(var t in e.find("div.input-group").remove(),a){var l=a[t];window.vmPropsHandler.propertyHandlers.list_text.addNewItem(e,l)}},addNewItem:function(e,a){if(void 0===a){var t=e.data("newEntry");void 0!==t&&(a=null===t?null:JSON.parse(JSON.stringify(t)))}$('<div class="input-group">'+window.vmPropsHandler.listButtonsPrepend(e)+'<input type="text" class="form-control">'+window.vmPropsHandler.listButtonsAppend(e)+"</div>").appendTo(e).find("input").val(a)},buildProperty:function(e,a,t){$(e).append('<div class="form-group"><label for="'+a+'">'+window.vmPropsHandler.escapeHTML(t.label)+'</label><div class="dataHolder" id="'+a+'"></div>'+(t.addable?'<div class="input-group mt-1"><button type="button" class="form-control btn btn-info" onclick="window.vmPropsHandler.propertyHandlers.list_text.addNewItem($(\'#'+a+"'));\">+</button></div>":"")+(void 0!==t.tooltip?'<small class="form-text text-muted">'+window.vmPropsHandler.escapeHTML(t.tooltip)+"</small>":"")+"</div>");var l=$(e).find("#"+a);t.addable&&(l.data("addable",!0),l.data("newEntry",t.newEntry)),t.removable&&l.data("removable",!0)},getPropertyValue:function(e){var a=[];return e.find("input.form-control").each((function(e,t){a.push($(t).val())})),a},displayValidation:function(e,a){if(!a.isValid){e.addClass("is-invalid");const t=e.find("input.form-control");for(const e of a.messages)if(!e.isValid){if(void 0===e.listEntry){t.addClass("is-invalid");break}t.eq(e.listEntry).addClass("is-invalid")}t.filter(":not(.is-invalid)").addClass("is-valid"),e.parent().children("div.input-group").children("button").addClass("is-invalid")}var t=e.parent();for(const e of a.messages)t.append('<div class="'+(e.isValid?"valid-feedback":"invalid-feedback")+'">'+e.message+"</div>");t.append(t.children("small.form-text"))}},list_number:{setPropertyValue:function(e,a){window.vmPropsHandler.propertyHandlers.list_text.setPropertyValue(e,a)},addNewItem:function(e,a){if(void 0===a){var t=e.data("newEntry");void 0!==t&&(a=null===t?null:JSON.parse(JSON.stringify(t)))}$('<div class="input-group">'+window.vmPropsHandler.listButtonsPrepend(e)+'<input type="number" class="form-control">'+window.vmPropsHandler.listButtonsAppend(e)+"</div>").appendTo(e).find("input").val(window.vmPropsHandler.propertyHandlers.number.format(a))},buildProperty:function(e,a,t){$(e).append('<div class="form-group"><label for="'+a+'">'+window.vmPropsHandler.escapeHTML(t.label)+'</label><div class="dataHolder" id="'+a+'"></div>'+(t.addable?'<div class="input-group mt-1"><button type="button" class="form-control btn btn-info" onclick="window.vmPropsHandler.propertyHandlers.list_number.addNewItem($(\'#'+a+"'));\">+</button></div>":"")+(void 0!==t.tooltip?'<small class="form-text text-muted">'+window.vmPropsHandler.escapeHTML(t.tooltip)+"</small>":"")+"</div>");var l=$(e).find("#"+a);t.addable&&(l.data("addable",!0),l.data("newEntry",t.newEntry)),t.removable&&l.data("removable",!0)},getPropertyValue:function(e){var a=[];return e.find("input.form-control").each((function(e,t){a.push(window.vmPropsHandler.propertyHandlers.number.parse($(t).val()))})),a},displayValidation:function(e,a){window.vmPropsHandler.propertyHandlers.list_text.displayValidation(e,a)}},object:{setPropertyValue:function(e,a){if(void 0===a&&(a=null),e.data("value",a),null===a){e.off("click.vmprops");var t=e.data("newEntry");e.data("addable")&&null!=t?(e.text("New"),e.on("click.vmprops",(function(){var a=e.data("newEntry");null!=a&&(window.vmPropsHandler.propertyHandlers.object.setPropertyValue(e,JSON.parse(JSON.stringify(e.data("newEntry")))),window.vmPropsHandler.gotoProperty(e.attr("id")))}))):e.text("No Value")}else e.text("Edit")},buildProperty:function(e,a,t){$(e).append('<div class="form-group"><label for="'+a+'">'+window.vmPropsHandler.escapeHTML(t.label)+'</label><div class="input-group"><button type="button" class="form-control dataHolder btn btn-secondary" id="'+a+'">Edit</button>'+(t.removable?'<div class="input-group-append ml-1"><button type="button" class="btn btn-danger" onclick="window.vmPropsHandler.propertyHandlers.object.setPropertyValue($(this).parent().prev(),null)">-</button></div>':"")+"</div>"+(void 0!==t.tooltip?'<small class="form-text text-muted">'+window.vmPropsHandler.escapeHTML(t.tooltip)+"</small>":"")+"</div>").find("#"+a).data("addable",t.addable).data("removable",t.removable).data("newEntry",t.newEntry).on("click.vmprops",(function(){window.vmPropsHandler.gotoProperty(a)}))},getPropertyValue:function(e){return e.data("value")},displayValidation:function(e,a){var t=e.closest(".form-group").children().last();for(const e of a.messages)t.after('<div class="'+(e.isValid?"valid-feedback":"invalid-feedback")+'">'+e.message+"</div>"),t=t.next();a.isValid||e.addClass("is-invalid")}},list_object:{setPropertyValue:function(e,a){for(var t in e.find("div.input-group").remove(),a){var l=a[t];window.vmPropsHandler.propertyHandlers.list_object.addNewItem(e,l)}},addNewItem:function(e,a){if(void 0===a){var t=e.data("newEntry");void 0!==t&&(a=null===t?null:JSON.parse(JSON.stringify(t)))}$('<div class="input-group">'+window.vmPropsHandler.listButtonsPrepend(e)+'<button type="button" class="form-control btn btn-secondary">'+window.vmPropsHandler.parseLabel(e.data("labelEntry"),a)+"</button>"+window.vmPropsHandler.listButtonsAppend(e)+"</div>").appendTo(e).find("button.form-control").first().data("value",a).on("click.vmprops",(function(){window.vmPropsHandler.gotoProperty(e.attr("id"),this)}))},buildProperty:function(e,a,t){$(e).append('<div class="form-group"><label for="'+a+'">'+window.vmPropsHandler.escapeHTML(t.label)+'</label><div class="dataHolder" id="'+a+'"></div>'+(t.addable?'<div class="input-group mt-1"><button type="button" class="form-control btn btn-info" onclick="window.vmPropsHandler.propertyHandlers.list_object.addNewItem($(\'#'+a+"'));\">+</button></div>":"")+(void 0!==t.tooltip?'<small class="form-text text-muted">'+window.vmPropsHandler.escapeHTML(t.tooltip)+"</small>":"")+"</div>");var l=$(e).find("#"+a);t.addable&&(l.data("addable",!0),window.vmPropsHandler.addImpliedDefaultValues(t.newEntry,t),l.data("newEntry",t.newEntry)),void 0!==t.labelEntry&&null!==t.labelEntry?l.data("labelEntry",t.labelEntry):l.data("labelEntry","Edit"),t.removable&&l.data("removable",!0)},getPropertyValue:function(e){var a=[];return e.find("button.form-control").each((function(e,t){a.push($(t).data("value"))})),a},displayValidation:function(e,a){if(!a.isValid){e.addClass("is-invalid");const t=e.find("button.form-control");for(const e of a.messages)if(!e.isValid){if(void 0===e.listEntry){t.addClass("is-invalid");break}t.eq(e.listEntry).addClass("is-invalid")}t.filter(":not(.is-invalid)").addClass("is-valid"),e.parent().children("div.input-group").children("button").addClass("is-invalid")}var t=e.parent();for(const e of a.messages)t.append('<div class="'+(e.isValid?"valid-feedback":"invalid-feedback")+'">'+e.message+"</div>");t.append(t.children("small.form-text"))}}}}window.onload=function(){var e=null;null!==window.opener?e=window.opener:null!==window.parent&&(e=window.parent),null!==e&&new Handler(e)};